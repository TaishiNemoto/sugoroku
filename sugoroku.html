<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>高知市すごろく（最終版）</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html,body{height:100%;margin:0;font-family:"Noto Sans JP",sans-serif;background:#0b1324;color:#fff;}
    .app{display:grid;grid-template-columns:360px 1fr;height:100%;}
    .panel{background:#111a33;padding:12px;display:flex;flex-direction:column;border-right:2px solid #1e2a4a;}
    #map{width:100%;height:100%;}
    h2{margin:0 0 10px;color:#7cc7ff;}
    button{background:#1779ff;border:none;color:white;padding:10px 14px;border-radius:8px;margin:5px 5px 0 0;font-weight:bold;cursor:pointer;}
    button:hover{opacity:0.9;}
    #log{background:#0f1730;flex:1;overflow-y:auto;margin-top:10px;border-radius:8px;padding:8px;font-size:14px;color:#a9c4ff;}
    /* サイコロ表示 */
    #diceDisplay{position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.6);padding:40px 70px;border-radius:20px;font-size:64px;font-weight:bold;display:none;z-index:9999;}
    /* 全画面画像モーダル */
    #photoModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:9999;}
    #photoModal img{max-width:90vw;max-height:90vh;border-radius:12px;box-shadow:0 0 20px rgba(0,0,0,.5);}
  </style>
</head>
<body>
<div class="app">
  <div class="panel">
    <h2>🎲 高知市すごろく</h2>
    <div>プレイヤー：<span id="playerName">土佐たび人</span></div>
    <div>所持金：<span id="money">¥3,000</span></div>
    <div>位置：<span id="pos">0 / -</span></div>
    <div>
      <button id="rollBtn">サイコロを振る</button>
      <button id="resetBtn">リセット</button>
    </div>
    <div id="log"></div>
  </div>
  <div id="map"></div>
</div>

<div id="diceDisplay"></div>
<div id="photoModal"><img id="photoView" src=""></div>

<script>
// === 高知スポット25件以上 ===
const ROUTE = [
  // あなたのJSONをそのまま貼り付けてもOK
  {"name":"高知城（スタート）","lat":33.560674,"lng":133.531532,"kind":"start","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/4/47/Kochi_Castle_Main_Tower.jpg/640px-Kochi_Castle_Main_Tower.jpg","info":"江戸時代の藩主山内氏による城郭。天守・本丸御殿などが現存し、城下町高知の中心。","category":"歴史建築","event":{"type":"info"}},
  {"name":"高知城歴史博物館","lat":33.5609,"lng":133.5325,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/8/8e/Kochi_Castle_History_Museum.jpg/640px-Kochi_Castle_History_Museum.jpg","info":"土佐藩の歴史や文化を学べる博物館。","category":"博物館／歴史","event":{"type":"info"}},
  {"name":"城西公園","lat":33.5632,"lng":133.5318,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/Josei_Park_Kochi.jpg/640px-Josei_Park_Kochi.jpg","info":"高知城の西側に広がる市民公園。桜の名所として人気。","category":"公園／休憩","event":{"type":"chance"}},
  {"name":"土佐の日曜市","lat":33.561474,"lng":133.538004,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/1/1e/Tosa_Nichiyouichi.jpg/640px-Tosa_Nichiyouichi.jpg","info":"元禄3年から続く街路市。地元の野菜や金物が並ぶ。","category":"市場／生活文化","event":{"type":"buy","price":500,"item":"新鮮野菜セット"}},
  {"name":"はりまや橋","lat":33.5580,"lng":133.5370,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/4/4a/Harimayabashi_Kochi.jpg/640px-Harimayabashi_Kochi.jpg","info":"“よさこい節”にも歌われる高知の象徴。","category":"歴史／ランドマーク","event":{"type":"quiz","q":"よさこい節で有名な『はりまや橋』に登場する小物は？","a":["金のかんざし","路面電車","桜"],"correct":0,"reward":600}},
  {"name":"ひろめ市場","lat":33.560547,"lng":133.535676,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/a/a8/Hirome_ichiba_Kochi.jpg/640px-Hirome_ichiba_Kochi.jpg","info":"高知市帯屋町の屋台市場。カツオのたたきが名物。","category":"グルメ／市場","event":{"type":"buy","price":800,"item":"カツオたたき札"}},
  {"name":"龍馬通り","lat":33.5604,"lng":133.5378,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/1/1c/Ryoma_Dori_Kochi.jpg/640px-Ryoma_Dori_Kochi.jpg","info":"土産物が並ぶアーケード通り。","category":"商店街／散策路","event":{"type":"info"}},
  {"name":"おびさんロード商店街","lat":33.5538,"lng":133.5409,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/6/6d/Obisan_Road_Kochi.jpg/640px-Obisan_Road_Kochi.jpg","info":"帯屋町から続く商店街。雑貨・食・お土産が充実。","category":"商店街／散策路","event":{"type":"info"}},
  {"name":"観光遊覧船 仁王丸","lat":33.5550,"lng":133.5400,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/2/29/Kochi_Sightseeing_Cruise_Kochi.jpg/640px-Kochi_Sightseeing_Cruise_Kochi.jpg","info":"鏡川や浦戸湾を巡る遊覧船。","category":"体験／水上観光","event":{"type":"chance"}},
  {"name":"鏡川プロムナード","lat":33.5600,"lng":133.5330,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/4/4f/Kagami_River_Promenade_Kochi.jpg/640px-Kagami_River_Promenade_Kochi.jpg","info":"鏡川沿いの遊歩道。散策に最適。","category":"自然／散策路","event":{"type":"info"}},
  {"name":"地球33番地","lat":33.56258,"lng":133.55666,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/0/0f/Chikyu33banchi_monument.jpg/640px-Chikyu33banchi_monument.jpg","info":"北緯33°33′33″・東経133°33′33″。数字“3”が並ぶ記念碑。","category":"トリビア／記念碑","event":{"type":"info"}},
  {"name":"高知県立文学館","lat":33.5555,"lng":133.5355,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/9/9b/Kochi_Prefectural_Literary_Museum.jpg/640px-Kochi_Prefectural_Literary_Museum.jpg","info":"地元作家の資料展示など文学文化を紹介。","category":"博物館／文化","event":{"type":"info"}},
  {"name":"高知県立美術館","lat":33.5598,"lng":133.5720,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/Kochi_Prefectural_Art_Museum.jpg/640px-Kochi_Prefectural_Art_Museum.jpg","info":"シャガール作品を中心に展示。","category":"芸術／文化","event":{"type":"quiz","q":"高知県立美術館で代表的な展示作家は？","a":["シャガール","ピカソ","北斎"],"correct":0,"reward":500}},
  {"name":"高知よさこい情報交流館","lat":33.5590,"lng":133.5375,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Yosakoi_Museum_Kochi.jpg/640px-Yosakoi_Museum_Kochi.jpg","info":"よさこい祭りの歴史や衣装展示。","category":"祭り／文化","event":{"type":"quiz","q":"よさこい祭りの開催月は？","a":["8月","5月","10月"],"correct":0,"reward":400}},
  {"name":"高知市文化プラザかるぽーと","lat":33.5597,"lng":133.5498,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/4/45/Carport_Kochi.jpg/640px-Carport_Kochi.jpg","info":"市民文化の拠点。展示やコンサートが行われる。","category":"文化／施設","event":{"type":"info"}},
  {"name":"竹林寺","lat":33.5530,"lng":133.5800,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/6/6a/Chikurinji_Kochi.jpg/640px-Chikurinji_Kochi.jpg","info":"四国霊場第31番札所。五重塔と庭園が有名。","category":"寺院／歴史建築","event":{"type":"info"}},
  {"name":"高知県立牧野植物園","lat":33.547532,"lng":133.579214,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/9/94/Makino_Botanical_Garden_Kochi.jpg/640px-Makino_Botanical_Garden_Kochi.jpg","info":"牧野富太郎博士ゆかりの植物園。","category":"自然／庭園","event":{"type":"chance"}},
  {"name":"土佐神社","lat":33.5610,"lng":133.5630,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/7/7a/Tosa_Shrine_Kochi.jpg/640px-Tosa_Shrine_Kochi.jpg","info":"土佐国一之宮。信仰の中心地。","category":"神社／宗教文化","event":{"type":"info"}},
  {"name":"桂浜 海のテラス","lat":33.4881,"lng":133.5765,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/5/5f/Katsurahama_Umi_no_Terrace.jpg/640px-Katsurahama_Umi_no_Terrace.jpg","info":"2023年開業の観光拠点。","category":"商業施設／観光案内","event":{"type":"buy","price":1000,"item":"お土産セット"}},
  {"name":"高知県立坂本龍馬記念館","lat":33.4912,"lng":133.5726,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/2/2e/Ryoma_Memorial_Museum_Kochi.jpg/640px-Ryoma_Memorial_Museum_Kochi.jpg","info":"龍馬ファン必見の資料館。","category":"歴史／博物館","event":{"type":"info"}},
  {"name":"龍王岬","lat":33.4875,"lng":133.5740,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/3/33/Ryuoumisaki_Kochi.jpg/640px-Ryuoumisaki_Kochi.jpg","info":"太平洋を一望できる展望地。","category":"絶景／岬","event":{"type":"info"}},
  {"name":"秦山公園","lat":33.5635,"lng":133.5448,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/f/f7/Hatazan_Park_Kochi.jpg/640px-Hatazan_Park_Kochi.jpg","info":"運動場を中心とした広大な公園。","category":"公園／スポーツ","event":{"type":"chance"}},
  {"name":"龍河洞","lat":33.6075,"lng":133.6625,"kind":"checkpoint","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/a/af/Ryugado.jpg/640px-Ryugado.jpg","info":"日本三大鍾乳洞の一つ。","category":"自然／鍾乳洞","event":{"type":"info"}},
  {"name":"桂浜（ゴール）","lat":33.4880,"lng":133.5760,"kind":"goal","img":"https://upload.wikimedia.org/wikipedia/commons/thumb/b/bf/Katsurahama_beach.jpg/640px-Katsurahama_beach.jpg","info":"坂本龍馬像が海を見つめる月の名所。","category":"観光名所","event":{"type":"info"}}
];

const CHANCE=[
  {text:"よさこい祭りに飛び入り参加！元気をもらって1マス進む。",effect:{move:+1}},
  {text:"雨で市場が中止。-¥300。",effect:{money:-300}},
  {text:"地元の人からおすそ分け！+¥400。",effect:{money:+400}},
  {text:"観光客に道案内して感謝された！+¥200。",effect:{money:+200}},
  {text:"坂本龍馬像の前で記念撮影！+¥300。",effect:{money:+300}},
];

const $=s=>document.querySelector(s);
const log=m=>{const p=document.createElement("div");p.textContent=m;$("#log").prepend(p);}
const fmt=v=>"¥"+v.toLocaleString();

// === 地図 ===
const map=L.map("map").setView([33.5589,133.543],12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

const latlngs=ROUTE.map(p=>[p.lat,p.lng]);
L.polyline(latlngs,{color:"#7cc7ff",weight:4}).addTo(map);

const markers=ROUTE.map((p,i)=>{
  const popup=`
  <div style="width:240px;color:#fff;background:linear-gradient(180deg,#0b1324,#111a33);border-radius:10px;padding:8px;">
    ${p.img?`<img src="${p.img}" class="popup-image" style="width:100%;border-radius:8px;margin-bottom:6px;cursor:zoom-in;">`:""}
    <b style="color:#7cc7ff;">${i}. ${p.name}</b><br>
    <small style="color:#a9c4ff;">${p.category}</small>
    <hr style="border:1px solid #1e2a4a;">
    <div style="font-size:13px;line-height:1.4;">
    ${p.info}
    </div>
  </div>`;
  const m=L.marker([p.lat,p.lng]).addTo(map);
  m.bindPopup(popup);
  return m;
});

// === 全画面画像モーダル ===
document.body.addEventListener("click",e=>{
  if(e.target.classList.contains("popup-image")){
    $("#photoView").src=e.target.src;
    $("#photoModal").style.display="flex";
  }
});
$("#photoModal").onclick=()=>$("#photoModal").style.display="none";

// === プレイヤー状態 ===
let state={pos:0,money:3000,items:[],finished:false};
const player=L.circleMarker(latlngs[0],{radius:8,color:"#7cc7ff",fillColor:"#7cc7ff",fillOpacity:.9}).addTo(map);

function updateHUD(){
  $("#pos").textContent=`${state.pos} / ${ROUTE.length-1}`;
  $("#money").textContent=fmt(state.money);
}

// === サイコロ演出 ===
function showDice(num){
  const d=$("#diceDisplay");
  d.textContent=`🎲 ${num}`;
  d.style.display="block";
  setTimeout(()=>{d.style.display="none";},1000);
}
const rollDice=()=>1+Math.floor(Math.random()*6);

// === アニメーション移動 ===
function movePlayer(steps){
  const goal=Math.min(state.pos+steps,ROUTE.length-1);
  function step(){
    if(state.pos<goal){
      state.pos++;
      player.setLatLng([ROUTE[state.pos].lat,ROUTE[state.pos].lng]);
      log(`🚶‍♂️ ${ROUTE[state.pos].name} に到着`);
      updateHUD();
      setTimeout(step,600);
    }else{
      onLand(ROUTE[state.pos]);
    }
  }
  step();
}

// === イベント処理 ===
function onLand(tile){
  map.panTo([tile.lat,tile.lng]);
  markers[state.pos].openPopup();
  const ev=tile.event;
  if(tile.kind==="goal"){
    alert(`🎉 ゴール！${tile.name}に到着！\nおめでとうございます！\n最終所持金：${fmt(state.money)}`);
    log(`🏁 ${tile.name}ゴール！ゲームクリア！`);
    state.finished=true;
    return;
  }
  switch(ev.type){
    case"info":
      state.items.push(tile.name);
      log(`📖 ${tile.name}のカードを入手。`);
      break;
    case"buy":
      if(state.money>=ev.price && confirm(`${tile.name}\n${fmt(ev.price)}で${ev.item}を購入しますか？`)){
        state.money-=ev.price;
        state.items.push(ev.item);
        log(`🛍️ ${ev.item}を購入。`);
      }else log("💸 所持金が足りません。");
      break;
    case"quiz":
      const ans=prompt(`${ev.q}\n${ev.a.map((a,i)=>`${i+1}. ${a}`).join("\n")}`);
      if(Number(ans)-1===ev.correct){state.money+=ev.reward;log(`✅ 正解！${fmt(ev.reward)}獲得。`);}
      else{state.money-=200;log(`❌ 不正解。-¥200。`);}
      break;
    case"chance":
      const c=CHANCE[Math.floor(Math.random()*CHANCE.length)];
      alert(`チャンス！\n${c.text}`);
      if(c.effect.money)state.money+=c.effect.money;
      if(c.effect.move)movePlayer(c.effect.move);
      log(`🎴 ${c.text}`);
      break;
  }
  updateHUD();
}

// === ボタン ===
$("#rollBtn").onclick=()=>{
  if(state.finished){alert("🎉 もうゴールしました！リセットして再挑戦しましょう。");return;}
  const d=rollDice();
  showDice(d);
  log(`🎲 サイコロ: ${d}`);
  movePlayer(d);
};
$("#resetBtn").onclick=()=>{
  state={pos:0,money:3000,items:[],finished:false};
  player.setLatLng(latlngs[0]);
  updateHUD();
  log("🔄 リセットしました。");
};

// === 初期化 ===
updateHUD();
log("👣 高知城から旅を始めよう！");
</script>
</body>
</html>
